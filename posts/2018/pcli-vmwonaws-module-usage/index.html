<!DOCTYPE html>
<html lang="en" class="wf-firasans-n4-active wf-active">
	<head>
    <link href="http://gmpg.org/xfn/11" rel="profile">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- Enable responsiveness on mobile devices -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">
    
    
    <meta name="generator" content="Hugo 0.37.1" />
    
    <title>PowerCLI - VMware Cloud on AWS Module Usage &middot; </title>
    <meta content="PowerCLI - VMware Cloud on AWS Module Usage - " property="og:title">
    <meta content=" - " property="og:description">
    <!-- CSS -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Serif:300,300i,400,400i,700,700i|Source+Code+Pro:300,300i,400,400i" rel="stylesheet">
    <link rel="stylesheet" href="https://kmruddy.github.iocss/print.css" media="print">
    <link rel="stylesheet" href="https://kmruddy.github.iocss/poole.css">
    <link rel="stylesheet" href="https://kmruddy.github.iocss/hyde.css">
    <!-- Font-Awesome -->
    <script defer src="https://use.fontawesome.com/releases/v5.0.13/js/all.js" integrity="sha384-xymdQtn1n3lH2wcu0qhcdaOpQwyoarkgLVxC/wZ5q7h9gHtxICrpcaSUfygqZGOe" crossorigin="anonymous"></script>
    <!-- highlight.js-->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <!-- Customised CSS -->
    <link rel="stylesheet" href="https://kmruddy.github.iocss/custom.css">
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <!-- Icons -->
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="/apple-touch-icon-144-precomposed.png">
    <link rel="shortcut icon" href="/favicon.png">
    

	</head>
    <body class=" ">
        <div class="sidebar">
  <div class="container text-center ">
    <div class="sidebar-about text-center">
      <a href="https://kmruddy.github.io"> <img src="/img/kmr.jpg" alt="Author Image" class="img-circle headshot center"> </a>
      <a href="https://kmruddy.github.io"><h1 class="brand">kmruddy.com</h1></a>
      <p class="lead">
         My notes and ramblings, normally about automation 
      </p>
    </div>
    <p>
      <section class="row text-center">
	
	<a href="https://twitter.com/kmruddy"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a>
	
	
	
	&nbsp;<a href="https://github.com/kmruddy"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
	&nbsp;<a href="https://linkedin.com/in/kmruddy"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a>
	
	
	&nbsp;<a href="https://stackoverflow.com/users/kmruddy"><i class="fab fa-stack-overflow fa-lg" aria-hidden="true"></i></a>
	
	
	
	
	
</section>

    </p>
    <p>
      
<div>
	<ul class="sidebar-nav">
		
		
				<li>
					<a href="/"> <span>Home</span></a>
				</li>
				<li>
					<a href="/about/"> <span>About</span></a>
				</li>
				<li>
					<a href="/catagories/posh"> <span>PowerShell</span></a>
				</li>
				<li>
					<a href="/catagories/pcli"> <span>PowerCLI</span></a>
				</li>
				<li>
					<a href="/catagories/vbrownbag"> <span>vBrownBag</span></a>
				</li>
		</li>
	</ul>
</div>

    </p>
    <p class="copyright">&copy; 2018 Kyle Ruddy.<br />
      <a href="https://creativecommons.org/licenses/by/4.0">Some Rights Reserved</a>.<br/>Built with <a href="https://gohugo.io/">Hugo</a> &amp; <a href="https://github.com/htr3n/hyde-hyde">hyde-hyde</a>.
    </p>
  </div>
  <div>
  </div>
</div>

        <div class="content container">
            <div class="post">
  <h1>PowerCLI - VMware Cloud on AWS Module Usage</h1>
  
  <div class="col-sm-12 col-md-12">
    <span class="text-left post-date meta">
            
       
        <i class="fas fa-calendar-alt"></i> Feb 20, 2018
      
      
      
      
        
        
            <br/>
             <i class="fas fa-tags"></i>
            
            <a class="meta" href="/tags/aws">aws</a> 
        
            <a class="meta" href="/tags/powercli">powercli</a> 
        
            <a class="meta" href="/tags/powershell">powershell</a> 
        
            <a class="meta" href="/tags/vmware">vmware</a>
        
      
      
      <br/>
      <i class="fas fa-clock"></i> 5 min read 
      </span>  
  </div>    
  
  

<p><a href="https://cloud.vmware.com/vmc-aws">VMware Cloud on AWS</a> is a new on-demand service that enables you to run applications across vSphere-based environments plus access to a broad range of AWS services. PowerCLI already helps to automate your VMware Cloud on AWS tasks! This includes tasks such as creating SDDCs, adding or removing ESXi hosts, managing firewall rules, and so forth. The VMware Cloud on AWS (VMC) module was released as a low-level, API access only, module and will feature the following cmdlets:</p>

<ul>
<li>Connect-VMC</li>
<li>Disconnect-VMC</li>
<li>Get-VmcService</li>
</ul>

<p>Let&rsquo;s take a look at how we can get started using this new module.</p>

<h2 id="getting-started">Getting Started</h2>

<p>When getting started with the VMC module, we&rsquo;ll notice immediately that it has a little different authentication process than the other PowerCLI connection cmdlets. This module requires you first acquire the OAuth Refresh Token from the <a href="https://console.cloud.vmware.com/">VMware Cloud Console</a>:
<img src="http://blogs.vmware.com/PowerCLI/files/2018/02/vmcmod_10.jpg" alt="Example: VMware Cloud on AWS Console - OAuth Refresh Token" /></p>

<p>Copy the refresh token, open a new PowerShell session, and connect to the VMC service with the following command:</p>

<pre><code>Connect-Vmc -RefreshToken xxxxxxx-xxxx-xxxx-xxxx-xxxxxxxx
</code></pre>

<p>Now that we are connected, let&rsquo;s start by doing some discovery. The more you work with this module, and the VMC API as a whole, the more you&rsquo;ll notice the need to be able to easily recall the organization (Org) ID. Therefore, let&rsquo;s start by looking into how we can discover information about our org.</p>

<p>First, we want to figure out what the service is itself with the <code>Get-VmcService</code> cmdlet. Notice that we can use the standard PowerShell filtering and wildcard usage to help make the discovery process a bit simpler. Example code:</p>

<pre><code>Get-VmcService *orgs
</code></pre>

<p>Next, we&rsquo;ll make use of the <code>Get-Member</code> cmdlet which will show us the available properties and methods for each issued command. We can pipeline the return from the &lsquo;com.vmware.vmc.orgs&rsquo; service to the <code>Get-Member</code> cmdlet and discover there&rsquo;s a &lsquo;Get&rsquo; and a &lsquo;List&rsquo; method available. Since we don&rsquo;t have any current information about the Orgs within this environment, we&rsquo;ll opt for the &lsquo;List&rsquo; method. Example code:</p>

<pre><code>$orgSvc = Get-VmcService com.vmware.vmc.orgs
$orgSvc | Get-Member
$orgSvc.list()
</code></pre>

<p><img src="http://blogs.vmware.com/PowerCLI/files/2018/02/vmcmod_01.jpg" alt="Example: Service and Org Discovery" /></p>

<p>Now that we have our org information, the next thing we will want to discover is information about the org&rsquo;s SDDC. That information can be found with the following commands:</p>

<pre><code>$sddcSvc = Get-VmcService com.vmware.vmc.orgs.sddcs
$sddcSvc.list($org.Id)
</code></pre>

<p><img src="http://blogs.vmware.com/PowerCLI/files/2018/02/vmcmod_02.jpg" alt="Example: SDDC Discovery" /></p>

<p>Notice, there&rsquo;s quite a bit of information to parse through. Let&rsquo;s look at a simple way to pull out some information about the SDDC&rsquo;s ESXi hosts. Example code:</p>

<pre><code>$sddc = $sddcSvc.list($org.id)
$sddc.resource_config.esx_hosts | select Name,Hostname,Provider,esx_state
</code></pre>

<p><img src="http://blogs.vmware.com/PowerCLI/files/2018/02/vmcmod_03.jpg" alt="Example: ESXi Host Information" /></p>

<p>VMware Cloud on AWS uses NSX under the covers to provision all of the networking. Therefore, we will also want to have an understanding of the Edge nodes that are available in the environment. This information is actually in a separate service. Remembering what we&rsquo;ve done previously, here&rsquo;s some example code to discover some basic information about the SDDC&rsquo;s Edge nodes:</p>

<pre><code>$edgeSvc = Get-VmcService *edges
$edges = $edgeSvc.get($org.id, $sddc.id).edge_page.data
$edges | select Name,id,edge_type,state,edge_status | ft -AutoSize
</code></pre>

<p><img src="http://blogs.vmware.com/PowerCLI/files/2018/02/vmcmod_04.jpg" alt="Example: NSX Edge Discovery" /></p>

<p>Another good area to be aware of in your SDDC are the firewall rules. These are also easily retrievable through the &lsquo;Get-VmcService&rsquo; cmdlet as well. Example of the firewall rules associated with the edge-2 node:</p>

<pre><code>$fwConfigSvc = Get-VmcService *firewall.config
$fwConfigE2 = $fwConfigSvc.get($tmmOrg.id,$tmmsddc.id,'edge-2')
$fwConfigE2.firewall_rules.firewall_rules | select Name,rule_id,enabled,action,description
</code></pre>

<p><img src="http://blogs.vmware.com/PowerCLI/files/2018/02/vmcmod_05.jpg" alt="Example: Firewall Rule Discovery" /></p>

<p>Last example, let&rsquo;s do something exciting! How about we automate the creation of an SDDC?</p>

<p>This is going to require quite a bit of what we&rsquo;ve learned so far, plus some new tricks. We can find the &lsquo;Create&rsquo; method against the com.vmware.vmc.orgs.sddc service. We see that input requires the Org ID and an &lsquo;sddc_config&rsquo; input. This is where it gets tricky.</p>

<p>If we remember back in the <a href="https://blogs.vmware.com/PowerCLI/2017/10/new-release-powercli-6-5-3.html">PowerCLI 6.5.3 release</a>, there was the addition of the &lsquo;Create&rsquo; method to a couple cmdlets. This method is also available with the <code>Get-VmcService</code> cmdlet. The whole point of this method is to allow us to create a specification in an easy manner. For this example, we&rsquo;re reference the &lsquo;sddcSvc&rsquo; variable, the &lsquo;Help&rsquo; property, then the create property. This shows us a property of &lsquo;sddc_config&rsquo;. This is the specification we&rsquo;ll need to use. The &lsquo;sddc_config&rsquo; property has this &lsquo;Create&rsquo; method available so we can automatically build out the specification. Pretty simple, right? We&rsquo;re not quite done quite yet though. Each SDDC can have multiple VPC subnets. Therefore, we also need to populate the spec&rsquo;s &lsquo;customer_subnet_ids&rsquo; list object with the &lsquo;Add&rsquo; method. Example code:</p>

<pre><code>$sddcCreateSpec = $sddcSvc.Help.create.sddc_config.Create()
$sddcCreateSpec.Name = &quot;PowerCLI_SDDC&quot;
$sddcCreateSpec.Provider = &quot;AWS&quot;
$sddcCreateSpec.region = &quot;US_WEST_2&quot;
$sddcCreateSpec.num_hosts = &quot;4&quot;
$accountLinkSpec = $sddcSvc.Help.create.sddc_config.account_link_sddc_config.Element.Create()
$accountLinkSpec.connected_account_id = &quot;xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx&quot;
$custSubId0 = $sddcSvc.Help.create.sddc_config.account_link_sddc_config.Element.customer_subnet_ids.Element.Create()
$custSubId0 = &quot;subnet-xxxxxxxx&quot;
$accountLinkSpec.customer_subnet_ids.Add($custSubId0)
$sddcCreateSpec.account_link_sddc_config.Add($accountLinkSpec)
$newSddc = $sddcSvc.create($org.Id, $sddcCreateSpec)
</code></pre>

<p><img src="http://blogs.vmware.com/PowerCLI/files/2018/02/vmcmod_06.jpg" alt="Example: SDDC Creation" /></p>

<p>The output above from our last create method is a task object. There&rsquo;s a service for those too!</p>

<p>Since the call we made is asynchronous, you can also have a bit of fun and build a progress checker as well! Here&rsquo;s some example code I tossed together while waiting on the SDDC to deploy:</p>

<pre><code>$taskSvc = Get-VmcService *task*
$progPercent = 0
while ($progPercent -ne 100) {
    $tempOut = $taskSvc.list($org.id) | Where-Object {$_.task_type -eq 'SDDC-PROVISION' -and $_.resource_id -eq $newSddc.resource_id} | sort updated | select -last 1
    $screenOut = &quot;&quot; | select PercentComplete, MinutesRemaining
    $screenOut.PercentComplete = $tempOut.progress_percent
    $screenOut.MinutesRemaining = $tempOut.estimated_remaining_minutes
    $screenOut
    $progPercent = $tempOut.progress_percent
    Start-Sleep -Seconds 60
}
</code></pre>

<p><img src="http://blogs.vmware.com/PowerCLI/files/2018/02/vmcmod_08.jpg" alt="Example: SDDC Creation Progress Output" /></p>

<h2 id="summary">Summary</h2>

<p><a href="https://cloud.vmware.com/vmc-aws">VMware Cloud on AWS</a> is a fantastic new service that enables you to run applications across vSphere environments as well as accessing a broad range of AWS services. Within this service, PowerCLI is one of the best ways to automate your VMware Cloud on AWS tasks! In this blog post we covered how to discover the available services, explore was methods are available as actions against each of those services, and how to start interacting with those services. We obtained detailed information about our organization, that org&rsquo;s SDDC and its accompanied configuration including firewall rules, and then had some fun while deploying a brand new SDDC! Check PowerCLI&rsquo;s functionality in your own VMware Cloud on AWS environment today!</p>

</div>
            <div class="footer">
                <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>

<script type="text/javascript">
    hljs.configure({languages: []});
    hljs.initHighlightingOnLoad();
</script>

    

            </div>
        </div>
        
        
    </body>
</html>
